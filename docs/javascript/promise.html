<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise | Frontend Notes</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="前端知识点">
    
    <link rel="preload" href="/frontend-notes/assets/css/0.styles.2ab3db1f.css" as="style"><link rel="preload" href="/frontend-notes/assets/js/app.96da5ce4.js" as="script"><link rel="preload" href="/frontend-notes/assets/js/2.c66189e9.js" as="script"><link rel="preload" href="/frontend-notes/assets/js/12.a6455198.js" as="script"><link rel="prefetch" href="/frontend-notes/assets/js/10.e7b6c838.js"><link rel="prefetch" href="/frontend-notes/assets/js/11.8c425335.js"><link rel="prefetch" href="/frontend-notes/assets/js/13.96444221.js"><link rel="prefetch" href="/frontend-notes/assets/js/14.bde08b07.js"><link rel="prefetch" href="/frontend-notes/assets/js/15.940e1f09.js"><link rel="prefetch" href="/frontend-notes/assets/js/16.ce441972.js"><link rel="prefetch" href="/frontend-notes/assets/js/17.11b3714b.js"><link rel="prefetch" href="/frontend-notes/assets/js/18.d6e4ada9.js"><link rel="prefetch" href="/frontend-notes/assets/js/3.0d1e4603.js"><link rel="prefetch" href="/frontend-notes/assets/js/4.ab196059.js"><link rel="prefetch" href="/frontend-notes/assets/js/5.61dedc87.js"><link rel="prefetch" href="/frontend-notes/assets/js/6.7862f44a.js"><link rel="prefetch" href="/frontend-notes/assets/js/7.cbb91b65.js"><link rel="prefetch" href="/frontend-notes/assets/js/8.fd7b7733.js"><link rel="prefetch" href="/frontend-notes/assets/js/9.2458ad30.js">
    <link rel="stylesheet" href="/frontend-notes/assets/css/0.styles.2ab3db1f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/frontend-notes/" class="home-link router-link-active"><!----> <span class="site-name">Frontend Notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/frontend-notes/" aria-current="page" class="sidebar-link">前言</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/frontend-notes/javascript" class="sidebar-heading clickable router-link-active open"><span>JavaScript基础</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend-notes/javascript/词法作用域.html" class="sidebar-link">词法作用域</a></li><li><a href="/frontend-notes/javascript/执行上下文.html" class="sidebar-link">执行上下文</a></li><li><a href="/frontend-notes/javascript/闭包.html" class="sidebar-link">闭包</a></li><li><a href="/frontend-notes/javascript/this.html" class="sidebar-link">this</a></li><li><a href="/frontend-notes/javascript/call&amp;apply&amp;bind.html" class="sidebar-link">call/apply/bind</a></li><li><a href="/frontend-notes/javascript/prototype.html" class="sidebar-link">原型&amp;继承</a></li><li><a href="/frontend-notes/javascript/promise.html" aria-current="page" class="active sidebar-link">Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend-notes/javascript/promise.html#promises-a" class="sidebar-link">Promises/A+</a></li><li class="sidebar-sub-header"><a href="/frontend-notes/javascript/promise.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/frontend-notes/javascript/深浅拷贝.html" class="sidebar-link">深/浅拷贝</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/frontend-notes/css" class="sidebar-heading clickable"><span>CSS基础</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h1> <h2 id="promises-a"><a href="#promises-a" class="header-anchor">#</a> Promises/A+</h2> <h3 id="_1-术语"><a href="#_1-术语" class="header-anchor">#</a> 1. 术语</h3> <ol><li><strong>“promise”</strong> 是一个具有 <strong>then</strong> 方法的对象或函数，该方法的行为符合本规范。</li> <li><strong>“thenable”</strong> 是一个具有 <strong>then</strong> 方法的对象或函数。</li> <li><strong>“value”</strong> 是任何 JavaScript 合法值。</li> <li><strong>“exception”</strong> 是一个用 <strong>throw</strong> 语句抛出的异常。</li> <li><strong>“reason”</strong> 是一个用于指示为何 <strong>promise</strong> 被拒绝的原因。</li></ol> <h3 id="_2-要求"><a href="#_2-要求" class="header-anchor">#</a> 2. 要求</h3> <h4 id="_2-1-promise-状态"><a href="#_2-1-promise-状态" class="header-anchor">#</a> 2.1. promise 状态</h4> <p>一个 <strong>promise</strong> 必定处于这三个状态之一：<strong>pending</strong>, <strong>fulfilled</strong>, <strong>rejected</strong>。</p> <p>2.1.1. 当处于 <strong>pending</strong> 时，一个 <strong>promise</strong> 可能转变成 <strong>fulfilled</strong> 或 <strong>rejected</strong>。</p> <p>2.1.2. 当处于 <strong>fulfilled</strong> 时，一个 <strong>promise</strong> 不能再转变成其他状态，且此时拥有一个不可变的 <strong>value</strong>。</p> <p>2.1.3. 当处于 <strong>rejected</strong> 时，一个 <strong>promise</strong> 不能再转变成其他状态，且此时拥有一个不可变的 <strong>reason</strong>。</p> <p>履行 <strong>promise</strong> 是指将该 <strong>promise</strong> 的状态从 <strong>pending</strong> 改为 <strong>fulfilled</strong> 并提供一个 <strong>value</strong>。</p> <p>拒绝 <strong>promise</strong> 是指将该 <strong>promise</strong> 的状态从 <strong>pending</strong> 改为 <strong>rejected</strong> 并提供一个 <strong>reason</strong>。</p> <h4 id="_2-2-then-方法"><a href="#_2-2-then-方法" class="header-anchor">#</a> 2.2. then 方法</h4> <p>一个 <strong>promise</strong> 必须提供一个 <strong>then</strong> 方法来访问它当前或最终的 <strong>value</strong> 或 <strong>reason</strong>。</p> <p>一个 <strong>promise</strong> 的 <strong>then</strong> 方法接收2个参数：</p> <div class="language-js extra-class"><pre class="language-js"><code>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>2.2.1. <strong>onFulfilled</strong> 和 <strong>onRejected</strong> 都是可选参数，当它们不是函数时，必须直接忽略。</p> <p>2.2.2. 如果 <strong>onFulfilled</strong> 是一个函数，那么</p> <ul><li>它必须在 <strong>promise</strong> 状态变为 <strong>fulfilled</strong> 后被调用，且 <strong>promise</strong> 的 <strong>value</strong> 作为它的第一个参数。</li> <li>它不能在 <strong>promise</strong> 状态变为 <strong>fulfilled</strong> 之前调用。</li> <li>它不能调用超过1次。</li></ul> <p>2.2.3. 如果 <strong>onRejected</strong> 是一个函数，那么</p> <ul><li>它必须在 <strong>promise</strong> 状态变为 <strong>rejected</strong> 后被调用，且 <strong>promise</strong> 的 <strong>reason</strong> 作为它的第一个参数。</li> <li>它不能在 <strong>promise</strong> 状态变为 <strong>rejected</strong> 之前调用。</li> <li>它不能调用超过1次。</li></ul> <p>2.2.4. <strong>onFulfilled</strong> 或 <strong>onRejected</strong> 必须等到执行栈中同步代码执行之后才能调用。</p> <p>2.2.5. <strong>onFulfilled</strong> 与 <strong>onRejected</strong> 必须当作一个普通函数调用，不影响 this 的默认指向。</p> <p>2.2.6. 同一个 <strong>promise</strong> 的 <strong>then</strong> 方法可以调用多次</p> <ul><li>当 <strong>promise</strong> 状态变为 <strong>fulfilled</strong> 时，所有 <strong>onFulfilled</strong> 回调必须按照 <strong>then</strong> 方法调用顺序执行。</li> <li>当 <strong>promise</strong> 状态变为 <strong>rejected</strong> 时，所有 <strong>onRejected</strong> 回调必须按照 <strong>then</strong> 方法调用顺序执行。</li></ul> <p>2.2.7. <strong>then</strong> 方法必须返回一个 <strong>promise</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>promise2 <span class="token operator">=</span> promise1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>如果 <strong>onFulfilled</strong> 或 <strong>onRejected</strong> 调用返回一个值 <strong>x</strong>，那么执行承诺处理流程 <strong>[[Resolve]](promise2, x)</strong>。</li> <li>如果 <strong>onFulfilled</strong> 或 <strong>onRejected</strong> 抛出一个异常 <strong>e</strong>，那么必须以 <strong>e</strong> 作为 <strong>reason</strong> 拒绝 <strong>promise2</strong>。</li> <li>如果 <strong>onFulfilled</strong> 不是一个函数并且 <strong>promise1</strong> 状态变为 <strong>fulfilled</strong>，那么 <strong>promise2</strong> 的状态必须变为 <strong>fulfilled</strong> 且与 <strong>promise1</strong> 拥有同样的 <strong>value</strong>。</li> <li>如果 <strong>onRejected</strong> 不是一个函数并且 <strong>promise1</strong> 状态变为 <strong>rejected</strong>，那么 <strong>promise2</strong> 的状态必须变为 <strong>rejected</strong> 且与 <strong>promise1</strong> 拥有同样的 <strong>reason</strong>。</li></ul> <h4 id="_2-3-承诺处理流程"><a href="#_2-3-承诺处理流程" class="header-anchor">#</a> 2.3. 承诺处理流程</h4> <p><strong>承诺处理流程</strong> 是一个抽象化的操作，它接收一个 <strong>promise</strong> 和一个 <strong>value</strong>，可以表示成 <strong>[[Resolve]](promise, x)</strong>。如果 <strong>x</strong> 是一个 <strong>thenable</strong>，并且 <strong>x</strong> 的行为表现得像一个 <strong>promise</strong>，那么会尝试让输入的 <strong>promise</strong> 采用 <strong>x</strong> 的状态，否则会以 <strong>x</strong> 作为 <strong>value</strong> 履行 <strong>promise</strong>。</p> <p>这种处理方式允许不同的 <strong>promise</strong> 实现之间互相操作，前提是它们都暴露了符合本规范的 <strong>then</strong> 方法。</p> <p>要运行 <strong>[[Resolve]](promise, x)</strong>，请执行以下步骤：</p> <p>2.3.1. 如果 <strong>promise</strong> 和 <strong>x</strong> 引用同一个对象，那么就拒绝 <strong>promise</strong> 并以 <strong>TypeError</strong> 作为 <strong>reason</strong>。</p> <p>2.3.2. 如果 <strong>x</strong> 是一个 <strong>promise</strong>，那么采用它的状态：</p> <ul><li>如果 <strong>x</strong> 处于 <strong>pending</strong>，那么<strong>promise</strong> 必须保持 <strong>pending</strong> 直到 <strong>x</strong> 状态转变。</li> <li>如果 <strong>x</strong> 处于 <strong>fulfilled</strong>，那么以同样的 <strong>value</strong> 履行 <strong>promise</strong>。</li> <li>如果 <strong>x</strong> 处于 <strong>rejected</strong>，那么以同样的 <strong>reason</strong> 拒绝 <strong>promise</strong>。</li></ul> <p>2.3.3. 否则，如果 <strong>x</strong> 是一个对象或函数，那么</p> <ul><li>首先将 <strong>x.then</strong> 缓存到变量 <strong>then</strong>；</li> <li>如果检索 <strong>x.then</strong> 属性时抛出异常 <strong>e</strong>，那么以 <strong>e</strong> 作为 <strong>reason</strong> 拒绝 <strong>promise</strong>；</li> <li>如果 <strong>then</strong> 是一个函数，那么执行 <strong>then.call(x, resolvePromise, rejectPromise)</strong> <ul><li>如果 <strong>resolvePromise</strong> 以参数 <strong>y</strong> 被调用，那么运行 <strong>[[Resolve]](promise, y)</strong>；</li> <li>如果 <strong>rejectPromise</strong> 以参数 <strong>r</strong> 被调用，那么以 <strong>r</strong> 作为 <strong>reason</strong> 拒绝 <strong>promise</strong>；</li> <li>如果 <strong>resolvePromise</strong> 和 <strong>rejectPromise</strong> 都被调用甚至多次调用，那么只处理第一次调用；</li> <li>如果调用 <strong>then</strong> 抛出异常 <strong>e</strong> <ul><li>如果 <strong>resolvePromise</strong> 或 <strong>rejectPromise</strong> 已被调用，就忽略之；</li> <li>否则以 <strong>e</strong> 作为 <strong>reason</strong> 拒绝 <strong>promise</strong></li></ul></li></ul></li> <li>如果 <strong>then</strong> 不是一个函数，那么以 <strong>x</strong> 作为 <strong>value</strong> 履行 <strong>promise</strong>。</li></ul> <p>2.3.4. 如果 <strong>x</strong> 不是对象或函数，那么以 <strong>x</strong> 作为 <strong>value</strong> 履行 <strong>promise</strong>。</p> <p>如果一个 <strong>promise</strong> 通过一个参与循环 <strong>thenable</strong> 链的 <strong>thenable</strong> 来解析，这样 <strong>[[Resolve]](promise, x)</strong> 最终会再次调用 <strong>[[Resolve]](promise, x)</strong>，从而陷入无限递归。本规范鼓励但是不要求实现一个机制来检测这样的递归，并以 <strong>TypeError</strong> 作为 <strong>reason</strong> 拒绝这个 <strong>promise</strong>。</p> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token constant">STATE</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;[STATE]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">CALLBACKS</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;[CALLBACKS]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">RESULT</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&quot;[RESULT]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * fulfill promise
 */</span>
<span class="token keyword">function</span> <span class="token function">fulfillPromise</span><span class="token punctuation">(</span>promise<span class="token operator">:</span> MyPromise<span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">[</span><span class="token constant">STATE</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  promise<span class="token punctuation">[</span><span class="token constant">STATE</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;fulfilled&quot;</span><span class="token punctuation">;</span>
  promise<span class="token punctuation">[</span><span class="token constant">RESULT</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> callbacks <span class="token operator">=</span> promise<span class="token punctuation">[</span><span class="token constant">CALLBACKS</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> onFulfilled<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject <span class="token punctuation">}</span> <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>promise<span class="token punctuation">[</span><span class="token constant">RESULT</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">[</span><span class="token constant">RESULT</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * reject promise
 */</span>
<span class="token keyword">function</span> <span class="token function">rejectPromise</span><span class="token punctuation">(</span>promise<span class="token operator">:</span> MyPromise<span class="token punctuation">,</span> reason<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise<span class="token punctuation">[</span><span class="token constant">STATE</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  promise<span class="token punctuation">[</span><span class="token constant">STATE</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;rejected&quot;</span><span class="token punctuation">;</span>
  promise<span class="token punctuation">[</span><span class="token constant">RESULT</span><span class="token punctuation">]</span> <span class="token operator">=</span> reason<span class="token punctuation">;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> callbacks <span class="token operator">=</span> promise<span class="token punctuation">[</span><span class="token constant">CALLBACKS</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> onRejected<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject <span class="token punctuation">}</span> <span class="token operator">=</span> callbacks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>promise<span class="token punctuation">[</span><span class="token constant">RESULT</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>promise<span class="token punctuation">[</span><span class="token constant">RESULT</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * promise resolution procedure
 */</span>
<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token operator">:</span> MyPromise<span class="token punctuation">,</span> x<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">rejectPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token constant">STATE</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;fulfilled&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fulfillPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token constant">RESULT</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token constant">STATE</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&quot;rejected&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">rejectPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token constant">RESULT</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">fulfillPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">rejectPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">function|object</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> then<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">rejectPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> resolve<span class="token operator">:</span> <span class="token function-variable function">Resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> reject<span class="token operator">:</span> <span class="token function-variable function">Reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">rejectPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">rejectPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">fulfillPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">fulfillPromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> <span class="token class-name">Reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span>reason<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> <span class="token class-name">Executor</span> <span class="token operator">=</span> <span class="token punctuation">(</span>resolve<span class="token operator">:</span> Resolve<span class="token punctuation">,</span> reject<span class="token operator">:</span> Reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> <span class="token class-name">OnFulfilled</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> <span class="token class-name">OnRejected</span> <span class="token operator">=</span> <span class="token punctuation">(</span>reason<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
<span class="token keyword">type</span> <span class="token class-name">Callback</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  onFulfilled<span class="token operator">?</span><span class="token operator">:</span> OnFulfilled<span class="token punctuation">;</span>
  onRejected<span class="token operator">?</span><span class="token operator">:</span> OnRejected<span class="token punctuation">;</span>
  resolve<span class="token operator">:</span> Resolve<span class="token punctuation">;</span>
  reject<span class="token operator">:</span> Reject<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span>promises<span class="token operator">:</span> MyPromise<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">const</span> results<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            results<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>count <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">race</span><span class="token punctuation">(</span>promises<span class="token operator">:</span> MyPromise<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      promises<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token punctuation">[</span><span class="token constant">STATE</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">&quot;pending&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;fulfilled&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;rejected&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;pending&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span><span class="token constant">RESULT</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">[</span><span class="token constant">CALLBACKS</span><span class="token punctuation">]</span><span class="token operator">:</span> Callback<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>executor<span class="token operator">:</span> Executor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> resolve<span class="token operator">:</span> <span class="token function-variable function">Resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> reject<span class="token operator">:</span> <span class="token function-variable function">Reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">rejectPromise</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">then</span><span class="token punctuation">(</span>onFulfilled<span class="token operator">?</span><span class="token operator">:</span> OnFulfilled<span class="token punctuation">,</span> onRejected<span class="token operator">?</span><span class="token operator">:</span> OnRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token constant">CALLBACKS</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        onFulfilled<span class="token punctuation">,</span>
        onRejected<span class="token punctuation">,</span>
        resolve<span class="token punctuation">,</span>
        reject<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">catch</span><span class="token punctuation">(</span>onRejected<span class="token operator">:</span> OnRejected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> MyPromise<span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/frontend-notes/javascript/prototype.html" class="prev">
        原型&amp;继承
      </a></span> <span class="next"><a href="/frontend-notes/javascript/深浅拷贝.html">
        深/浅拷贝
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/frontend-notes/assets/js/app.96da5ce4.js" defer></script><script src="/frontend-notes/assets/js/2.c66189e9.js" defer></script><script src="/frontend-notes/assets/js/12.a6455198.js" defer></script>
  </body>
</html>
